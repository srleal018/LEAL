<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Leal Scripts | Karma System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body { background-color: #05070a; color: #e2e8f0; }
        .glass { background: rgba(15, 23, 42, 0.8); backdrop-filter: blur(12px); border: 1px solid rgba(59, 130, 246, 0.1); }
        .karma-boost { transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .karma-boost:active { transform: scale(1.5) rotate(15deg); }
    </style>
</head>
<body class="min-h-screen pb-20">

    <nav class="glass sticky top-0 z-50 p-4 mb-10">
        <div class="container mx-auto flex justify-between items-center">
            <h1 class="font-black text-2xl tracking-tighter text-white">LEAL<span class="text-blue-500">SCRIPTS</span></h1>
            <div id="authStatus">
                <button id="btnGoogle" class="bg-blue-600 hover:bg-blue-500 text-white px-6 py-2 rounded-full font-bold text-sm transition">LOGIN GOOGLE</button>
            </div>
        </div>
    </nav>

    <div class="max-w-2xl mx-auto px-4">
        
        <div id="postArea" class="hidden glass p-6 rounded-3xl mb-12 shadow-2xl shadow-blue-500/5">
            <div class="flex items-center gap-3 mb-4">
                <img id="myUserPhoto" class="w-10 h-10 rounded-full border-2 border-blue-500">
                <span id="myUserName" class="font-bold"></span>
            </div>
            <textarea id="reviewText" class="w-full bg-slate-900/50 border border-slate-700 rounded-2xl p-4 text-white outline-none focus:border-blue-500 transition" placeholder="Escreva sua avaliação profissional..." rows="3"></textarea>
            <button id="btnPublish" class="w-full mt-4 bg-gradient-to-r from-blue-600 to-indigo-600 py-3 rounded-xl font-bold hover:opacity-90 transition">PUBLICAR AVALIAÇÃO</button>
        </div>

        <div id="feed" class="space-y-6">
            <div class="text-center text-slate-600 animate-pulse">Aguardando conexão com a rede...</div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, serverTimestamp, doc, updateDoc, arrayUnion } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCOk0bV5VwLBiaZ_vL5a8kpYzOCmqTad0I",
            authDomain: "leal-1a27b.firebaseapp.com",
            projectId: "leal-1a27b",
            storageBucket: "leal-1a27b.firebasestorage.app",
            messagingSenderId: "935085322117",
            appId: "1:935085322117:web:e8454ce939b8035b809eec"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const provider = new GoogleAuthProvider();

        let currentUser = null;

        // --- AUTH ---
        document.getElementById('btnGoogle').onclick = () => signInWithPopup(auth, provider);

        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                document.getElementById('postArea').classList.remove('hidden');
                document.getElementById('authStatus').innerHTML = `<img src="${user.photoURL}" class="w-10 h-10 rounded-full border-2 border-blue-500">`;
                document.getElementById('myUserPhoto').src = user.photoURL;
                document.getElementById('myUserName').innerText = user.displayName;
                initFeed();
            }
        });

        // --- MECÂNICA: PUBLICAR ---
        document.getElementById('btnPublish').onclick = async () => {
            const txt = document.getElementById('reviewText').value;
            if(!txt) return;

            await addDoc(collection(db, "reviews"), {
                name: currentUser.displayName,
                photo: currentUser.photoURL,
                text: txt,
                karma: 0,
                voters: [], // Lista de UIDs que votaram
                createdAt: serverTimestamp()
            });
            document.getElementById('reviewText').value = "";
        };

        // --- MECÂNICA: UPVOTE (KARMA) ---
        window.giveKarma = async (docId) => {
            if(!currentUser) return alert("Logue para votar!");
            
            const reviewRef = doc(db, "reviews", docId);
            
            // Incrementa o Karma e adiciona o usuário na lista de votantes
            await updateDoc(reviewRef, {
                karma: Number(document.getElementById(`val-${docId}`).innerText) + 1,
                voters: arrayUnion(currentUser.uid)
            }).catch(() => alert("Você já fortaleceu essa avaliação!"));
        };

        // --- RENDER FEED ---
        function initFeed() {
            const q = query(collection(db, "reviews"), orderBy("createdAt", "desc"));
            onSnapshot(q, (snapshot) => {
                const feed = document.getElementById('feed');
                feed.innerHTML = "";
                snapshot.forEach((doc) => {
                    const data = doc.data();
                    const hasVoted = data.voters?.includes(currentUser?.uid);
                    
                    feed.innerHTML += `
                        <div class="glass p-6 rounded-3xl border-l-4 border-blue-500 shadow-lg">
                            <div class="flex justify-between items-start">
                                <div class="flex items-center gap-3 mb-4">
                                    <img src="${data.photo}" class="w-10 h-10 rounded-full">
                                    <div>
                                        <h4 class="font-bold text-sm text-white">${data.name}</h4>
                                        <p class="text-[10px] text-slate-500 uppercase tracking-widest">Verificado</p>
                                    </div>
                                </div>
                                <div class="text-right">
                                    <button onclick="giveKarma('${doc.id}')" ${hasVoted ? 'disabled' : ''} 
                                        class="karma-boost ${hasVoted ? 'text-blue-500' : 'text-slate-500 hover:text-yellow-400'}">
                                        <i class="fas fa-bolt text-xl"></i>
                                    </button>
                                    <div class="text-xs font-black text-slate-400">KARMA: <span id="val-${doc.id}" class="text-blue-400">${data.karma || 0}</span></div>
                                </div>
                            </div>
                            <p class="text-slate-300 leading-relaxed text-sm bg-black/20 p-4 rounded-xl border border-white/5">${data.text}</p>
                            
                            <div class="mt-4 flex items-center gap-4 text-[10px] font-bold text-slate-600 uppercase">
                                <span class="hover:text-blue-400 cursor-pointer"><i class="fas fa-reply mr-1"></i> Responder</span>
                                <span><i class="fas fa-clock mr-1"></i> Just Now</span>
                            </div>
                        </div>
                    `;
                });
            });
        }
    </script>
</body>
</html>
